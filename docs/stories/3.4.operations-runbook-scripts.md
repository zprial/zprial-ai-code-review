# Story 3.4: Operations Runbook & Deployment Scripts

## Status
Ready

## Story
**As an** 运维工程师,
**I want** 拥有完整的运行手册和部署验证脚本,
**so that** 可以标准化上线、巡检与故障处理流程。

## Acceptance Criteria
1. 填写 `docs/runbook.md` 占位信息：角色联系人、访问入口、脚本说明等，并与最新流程保持一致。
2. 实现并提交 `scripts/post-verify.sh`, `scripts/staging-smoke.sh`, `scripts/rollback-check.sh`，可在本地和 CI 中执行，输出明确的成功/失败状态。
3. GitLab CI 在部署阶段调用以上脚本（至少在测试/预发环境验证 post-verify），失败时阻断发布并提供日志。
4. 发布公告模板与值班排班信息在 Runbook 中可查，确保上线前有明确联系人与升级路径。

## Tasks / Subtasks
- [ ] 补全 Runbook 联系人与关键信息（AC: 1,4）
  - [ ] 录入值班 ops、工程经理、审查工程师、产品负责人联系方式（AC: 1,4）
  - [ ] 确认访问入口、监控面板、Alertmanager 路由信息准确（AC: 1）
- [ ] 编写部署与验证脚本（AC: 2）
  - [ ] `scripts/post-verify.sh`：调用健康检查、队列状态、发送测试通知（AC: 2）
  - [ ] `scripts/staging-smoke.sh`：在预发创建测试 MR、验证评论生成、刷新报表（AC: 2）
  - [ ] `scripts/rollback-check.sh`：回滚后验证服务恢复、数据库迁移状态（AC: 2）
- [ ] 集成脚本至 CI/CD 流程（AC: 3）
  - [ ] 在 GitLab CI 的 `post-verify` 阶段执行脚本并上传日志（AC: 3）
  - [ ] 失败时触发 Alertmanager 或钉钉通知（AC: 3）
- [ ] 更新发布公告模板与排班说明（AC: 4）
  - [ ] 在 Runbook 添加公告示例与排班表引用位置（AC: 4）

## Dev Notes
- 参考 `docs/deployment-playbook.md` 的阶段划分和验证要求；确保脚本与文档一致。
- Alert & 通知逻辑见 `docs/runbook.md:66-88` 与 `docs/architecture.md:198-208`，脚本失败需调用相同告警机制。
- 脚本使用 Bash + curl/Node 脚本均可，注意在 CI 内的凭证获取（KMS/环境变量）。
- Runbook 更新后应记录在 Change Log，并通知运维/产品团队。

### Testing
- 本地 dry-run 验证每个脚本在测试环境可执行；CI pipeline 需有至少一次成功记录。
- 编写简单单元测试或 shellcheck 规则确保脚本质量。
- 手动演练一次回滚流程并在 Runbook 记录结果。

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-18 | 0.1 | 初始草稿 | PO Sarah |
| 2025-10-20 | 0.2 | Status set to Ready | PO Sarah |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

